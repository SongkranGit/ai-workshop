openapi: 3.1.0
info:
  title: LBK Points - Transfer API
  version: 1.0.0
  description: |
    โอนแต้ม, ดูสถานะ, และค้นประวัติ
servers:
  - url: http://localhost:3000/api
    description: Development server

tags:
  - name: Transfers

components:
  parameters:
    TransferLookupIdParam:
      name: id
      in: path
      required: true
      description: Transfer ID (idemKey) สำหรับค้นหาสถานะ
      schema:
        type: string
        minLength: 8
        maxLength: 128

    UserIdQuery:
      name: userId
      in: query
      required: true
      description: แสดงเฉพาะรายการที่เกี่ยวข้องกับ userId
      schema:
        type: integer
        minimum: 1

    PageQuery:
      name: page
      in: query
      required: false
      description: หน้าที่ต้องการ (เริ่มที่ 1)
      schema:
        type: integer
        minimum: 1
        default: 1

    PageSizeQuery:
      name: pageSize
      in: query
      required: false
      description: จำนวนต่อหน้า (1-200)
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 20

  schemas:
    TransferStatus:
      type: string
      enum: [pending, processing, completed, failed, cancelled, reversed]

    Transfer:
      type: object
      required:
        - idemKey
        - fromUserId
        - toUserId
        - amount
        - status
        - createdAt
        - updatedAt
      properties:
        idemKey:
          type: string
          description: Idempotency-Key ที่เป็น ID อ้างอิงหลัก
        transferId:
          type: integer
          description: เลขไอดีภายในระบบ (autoincrement)
        fromUserId:
          type: integer
          minimum: 1
        toUserId:
          type: integer
          minimum: 1
        amount:
          type: integer
          minimum: 1
          description: จำนวนแต้ม/เงิน (integer, หน่วย cents หรือ points)
        status:
          $ref: '#/components/schemas/TransferStatus'
        note:
          type: string
          nullable: true
          maxLength: 512
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true
        failReason:
          type: string
          nullable: true

    TransferCreateRequest:
      type: object
      required: [fromUserId, toUserId, amount]
      properties:
        fromUserId:
          type: integer
          minimum: 1
        toUserId:
          type: integer
          minimum: 1
        amount:
          type: integer
          minimum: 1
        note:
          type: string
          nullable: true
          maxLength: 512

    TransferCreateResponse:
      type: object
      properties:
        transfer:
          $ref: '#/components/schemas/Transfer'

    TransferGetResponse:
      type: object
      properties:
        transfer:
          $ref: '#/components/schemas/Transfer'

    TransferListItem:
      allOf:
        - $ref: '#/components/schemas/Transfer'

    TransferListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/TransferListItem'
        page:
          type: integer
          minimum: 1
        pageSize:
          type: integer
          minimum: 1
        total:
          type: integer
          minimum: 0

    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: string

  responses:
    BadRequest:
      description: คำขอไม่ถูกต้อง
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: ไม่พบข้อมูล
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Conflict:
      description: ความขัดแย้ง (เช่น แต้มไม่พอ)
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    Unprocessable:
      description: ตรวจรูปแบบผ่าน แต่ทำงานต่อไม่ได้
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

paths:
  /transfers:
    post:
      tags: [Transfers]
      summary: สร้างคำสั่งโอนแต้ม
      description: สร้างรายการโอนแต้มแบบอะตอมมิก ระบบจะ generate idemKey อัตโนมัติ
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransferCreateRequest'
            examples:
              sample:
                value:
                  fromUserId: 1
                  toUserId: 2
                  amount: 250
                  note: "ขอบคุณสำหรับช่วยงาน"
      responses:
        '201':
          description: สร้างสำเร็จ
          headers:
            Idempotency-Key:
              description: idemKey ที่ระบบสร้างให้
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransferCreateResponse'
              examples:
                success:
                  value:
                    transfer:
                      idemKey: "5d1f8c7a-2b5b-4b1f-9f2a-8f50b0a8d9f3"
                      transferId: 1
                      fromUserId: 1
                      toUserId: 2
                      amount: 250
                      status: completed
                      note: "ขอบคุณสำหรับช่วยงาน"
                      createdAt: "2025-10-17T14:03:12Z"
                      updatedAt: "2025-10-17T14:03:12Z"
                      completedAt: "2025-10-17T14:03:12Z"
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          $ref: '#/components/responses/Conflict'
        '422':
          $ref: '#/components/responses/Unprocessable'

    get:
      tags: [Transfers]
      summary: ค้น/ดูประวัติการโอน
      description: แสดงรายการที่ userId เกี่ยวข้อง (ทั้ง sender และ receiver)
      parameters:
        - $ref: '#/components/parameters/UserIdQuery'
        - $ref: '#/components/parameters/PageQuery'
        - $ref: '#/components/parameters/PageSizeQuery'
      responses:
        '200':
          description: รายการที่พบ
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransferListResponse'
              examples:
                page1:
                  value:
                    data:
                      - idemKey: "5d1f8c7a-2b5b-4b1f-9f2a-8f50b0a8d9f3"
                        transferId: 1
                        fromUserId: 1
                        toUserId: 2
                        amount: 250
                        status: completed
                        createdAt: "2025-10-17T14:03:12Z"
                        updatedAt: "2025-10-17T14:03:12Z"
                        completedAt: "2025-10-17T14:03:12Z"
                    page: 1
                    pageSize: 20
                    total: 1
        '400':
          $ref: '#/components/responses/BadRequest'

  /transfers/{id}:
    get:
      tags: [Transfers]
      summary: ดูสถานะคำสั่งโอน
      description: ใช้ idemKey เป็น id parameter
      parameters:
        - $ref: '#/components/parameters/TransferLookupIdParam'
      responses:
        '200':
          description: ข้อมูลรายการโอน
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TransferGetResponse'
              examples:
                found:
                  value:
                    transfer:
                      idemKey: "5d1f8c7a-2b5b-4b1f-9f2a-8f50b0a8d9f3"
                      transferId: 1
                      fromUserId: 1
                      toUserId: 2
                      amount: 250
                      status: completed
                      note: "ขอบคุณสำหรับช่วยงาน"
                      createdAt: "2025-10-17T14:03:12Z"
                      updatedAt: "2025-10-17T14:03:12Z"
                      completedAt: "2025-10-17T14:03:12Z"
        '404':
          $ref: '#/components/responses/NotFound'
